<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hobivia ‚Äî Carte</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="" defer></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer></script>

  <style>
    :root{ --vert:#1B4F46; --beige:#EDE6DA; --cta:#D07B4E; --noir:#1c1f1e; --blanc:#fff; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--beige);}    
    .page{display:grid;grid-template-rows:auto 1fr;min-height:100vh}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--noir);color:var(--blanc);position:sticky;top:0;z-index:1000}
    header .brand{font-weight:600;letter-spacing:.3px}
    header .controls{display:flex;gap:8px;flex-wrap:wrap}
    .control{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);border-radius:12px;padding:8px 10px}
    .control input,.control select{background:transparent;border:none;outline:none;color:#fff}
    .control input::placeholder{color:#ddd}
    #map{width:100%;height:calc(100vh - 140px)}
    .legend{position:absolute;right:12px;bottom:12px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:8px 10px;z-index:600}
    .legend h4{margin:0 0 6px 0;font-size:13px}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);font-size:14px;z-index:2000;display:none}
    .error{background:#b00020}
    a.btn{color:#fff;text-decoration:none}

    /* Hero + effets fluides */
    .hero{position:relative;overflow:hidden;background:linear-gradient(135deg, rgba(27,79,70,.08), rgba(208,123,78,.08));border-bottom:1px solid rgba(0,0,0,.06)}
    .hero-inner{max-width:1100px;margin:0 auto;padding:18px 16px;display:flex;align-items:center;gap:16px}
    .hero h1{margin:0;font-size:18px;line-height:1.35;color:#1c1f1e;font-weight:600}
    .flow{position:absolute;inset:0;pointer-events:none}
    .blob{position:absolute;top:50%;width:38vw;max-width:520px;aspect-ratio:1/1;border-radius:50%;filter:blur(30px);opacity:.18}
    .blob.left{left:-20vw;background:radial-gradient(circle at 30% 50%, var(--vert), transparent 60%);animation:slideLeft 9s ease-in-out infinite alternate}
    .blob.right{right:-20vw;background:radial-gradient(circle at 70% 50%, var(--cta), transparent 60%);animation:slideRight 9s ease-in-out infinite alternate}
    @keyframes slideLeft{from{transform:translateX(-4vw)} to{transform:translateX(10vw)}}
    @keyframes slideRight{from{transform:translateX(4vw)} to{transform:translateX(-10vw)}}
    .fade-in{animation:fadeIn .6s ease-out both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none}}
    .slide-in-left{animation:slideInLeft .7s cubic-bezier(.22,1,.36,1) both}
    .slide-in-right{animation:slideInRight .7s cubic-bezier(.22,1,.36,1) both}
    @keyframes slideInLeft{from{opacity:0;transform:translateX(-16px)} to{opacity:1;transform:none}}
    @keyframes slideInRight{from{opacity:0;transform:translateX(16px)} to{opacity:1;transform:none}}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">üó∫Ô∏è Hobivia ¬∑ Carte</div>
      <div class="controls slide-in-right">
        <label class="control" title="Recherche texte">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35" stroke="#fff" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#fff" stroke-width="2"/></svg>
          <input id="q" type="search" placeholder="Rechercher‚Ä¶ (nom, ville, tags)" />
        </label>
        <label class="control" title="Filtrer par cat√©gorie">
          <select id="cat">
            <option value="">Toutes cat√©gories</option>
          </select>
        </label>
        <a id="resetBtn" class="control btn" href="#" title="R√©initialiser">R√©initialiser</a>
      </div>
    </header>

    <section class="hero fade-in" aria-label="Intro carte Hobivia">
      <div class="flow">
        <div class="blob left"></div>
        <div class="blob right"></div>
      </div>
      <div class="hero-inner">
        <h1 class="slide-in-left">Chaque point sur la carte est une exp√©rience unique √† vivre. Lequel sera le tien ?</h1>
      </div>
    </section>

    <div id="map" class="fade-in"></div>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
    // ====== üîó CONFIG ======
    // URL par d√©faut vers ton JSON global (surchargable par ?data=)
    const JSON_URL = (new URLSearchParams(location.search).get('data'))
      || '/assets/hobivia-global.json';

    // ====== üß† UTIL ======
    const $ = sel => document.querySelector(sel);
    const params = new URLSearchParams(location.search);
    function showToast(msg, opts={}){
      const el = $('#toast');
      el.textContent = msg; el.className = 'toast ' + (opts.error ? 'error' : '');
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, opts.duration||3000);
    }
    function normStr(v){ return (v||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); }

    // Champs robustes
    function getLatLng(item){
      const lat = item.lat ?? item.latitude ?? item.Latitude ?? item.LAT;
      const lng = item.lng ?? item.lon ?? item.longitude ?? item.Longitude ?? item.LNG ?? item.LON;
      return [Number(lat), Number(lng)];
    }
    function getName(item){ return item.name ?? item.title ?? item.nom ?? item.Nom ?? 'Sans nom'; }
    function getCategory(item){ return item.category ?? item.categorie ?? item.type ?? 'Divers'; }
    function getCity(item){ return item.city ?? item.ville ?? item.location ?? ''; }
    function getTags(item){
      const tags = item.tags ?? item.motsCles ?? item.keywords ?? [];
      return Array.isArray(tags) ? tags : (typeof tags === 'string' ? tags.split(',').map(t=>t.trim()) : []);
    }
    function getImage(item){
      if (item.image) return item.image;
      if (item.thumbnail) return item.thumbnail;
      if (Array.isArray(item.images) && item.images.length) return item.images[0];
      return null;
    }
    function getPrice(item){
      const p = item.priceFrom ?? item.price_from ?? item.prixFrom ?? item.prix ?? item.minPrice ?? item.prixMin ?? item.a_partir_de;
      const currency = item.currency ?? item.devise ?? '‚Ç¨';
      if (p == null || p === '') return null;
      const n = Number(p);
      const value = Number.isFinite(n) ? Math.round(n) : p;
      return `√Ä partir de ${value}${currency === '‚Ç¨' ? '‚Ç¨' : ' ' + currency}`;
    }

    function getPopupHtml(item){
      const name = getName(item);
      const city = getCity(item);
      const cat = getCategory(item);
      const url = item.url ?? item.link ?? item.slug ?? null;
      const desc = item.shortDescription ?? item.resume ?? item.description ?? '';
      const img = getImage(item);
      const price = getPrice(item);
      const lines = [];
      lines.push(`<div style="min-width:240px;max-width:300px">`);
      if (img) lines.push(`<img src="${img}" alt="${name}" style="width:100%;border-radius:12px;margin-bottom:8px;object-fit:cover;max-height:160px"/>`);
      lines.push(`<div style="display:flex;align-items:baseline;gap:8px;justify-content:space-between;margin-bottom:4px">`);
      lines.push(`<div style="font-weight:700">${name}</div>`);
      if (price) lines.push(`<div style="font-size:12px;background:#1B4F46;color:#fff;padding:4px 8px;border-radius:999px">${price}</div>`);
      lines.push(`</div>`);
      lines.push(`<div style="font-size:12px;color:#444;margin-bottom:6px">${[city, cat].filter(Boolean).join(' ‚Ä¢ ')}</div>`);
      if (desc) lines.push(`<div style="font-size:13px;line-height:1.35;margin-bottom:8px">${desc}</div>`);
      if (url) lines.push(`<a href="${url}" target="_blank" rel="noopener" style="display:inline-block;padding:8px 12px;border-radius:10px;background:#1B4F46;color:#fff;text-decoration:none">Voir la fiche</a>`);
      lines.push(`</div>`);
      return lines.join('');
    }

    // ====== üó∫Ô∏è MAP ======
    let map, clusterGroup, allData = [], markers = [];

    // üé® Couleurs par cat√©gorie
    const PALETTE = ['#1B4F46','#D07B4E','#2D6CDF','#B84D8E','#6F8A2E','#E1A917','#6B4F2A','#3F8A8C','#8C3F3F','#5B5B8C'];
    const categoryColorMap = new Map();
    function getColorForCategory(cat){
      const key = (cat||'Divers').toString();
      if (!categoryColorMap.has(key)){
        const idx = categoryColorMap.size % PALETTE.length;
        categoryColorMap.set(key, PALETTE[idx]);
      }
      return categoryColorMap.get(key);
    }
    function makeDotIcon(color){
      return L.divIcon({
        className: 'dot-marker',
        html: `<span style="display:inline-block;width:14px;height:14px;border-radius:50%;background:${color};box-shadow:0 0 0 2px #fff, 0 1px 4px rgba(0,0,0,.3);"></span>`,
        iconSize: [16,16],
        iconAnchor: [8,8]
      });
    }

    function initMap(){
      map = L.map('map', { zoomControl: true, minZoom: 2 });
      // Basemap moderne (CARTO Light)
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 20,
        attribution: '&copy; OpenStreetMap contributors, &copy; CARTO'
      }).addTo(map);

      clusterGroup = L.markerClusterGroup({
        showCoverageOnHover: false,
        spiderfyOnMaxZoom: true,
        disableClusteringAtZoom: 12
      });
      map.addLayer(clusterGroup);
      map.setView([20, 0], 2);
    }

    function addPoints(data){
      clusterGroup.clearLayers();
      markers = [];
      const filtered = applyFilters(data);

      filtered.forEach(item => {
        const [lat, lng] = getLatLng(item);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
        const color = getColorForCategory(getCategory(item));
        const marker = L.marker([lat, lng], { icon: makeDotIcon(color), title: getName(item) });
        marker.bindPopup(getPopupHtml(item));
        clusterGroup.addLayer(marker);
        markers.push(marker);
      });

      fitToMarkers();
      updateCategoryOptions(data);
      updateURLFromControls();
      updateLegend(filtered.length);
    }

    function fitToMarkers(){
      if (markers.length === 0) { map.setView([20,0], 2); return; }
      const group = L.featureGroup(markers);
      try { map.fitBounds(group.getBounds().pad(0.15), { animate: false }); } catch(e){}
    }

    function updateLegend(count){
      let el = document.querySelector('.legend');
      if (!el){
        el = document.createElement('div');
        el.className = 'legend';
        el.innerHTML = '<h4>R√©sultats</h4><div id="legendCount">‚Äî</div><div id="legendCats" style="margin-top:6px;display:grid;gap:4px"></div>';
        document.body.appendChild(el);
      }
      document.getElementById('legendCount').textContent = `${count} point${count>1?'s':''}`;
      const catWrap = document.getElementById('legendCats');
      const cats = Array.from(new Set(allData.map(getCategory)));
      catWrap.innerHTML = cats.map(c=>{
        const col = getColorForCategory(c);
        const n = allData.filter(i=>getCategory(i)===c).length;
        return `<div style="display:flex;align-items:center;gap:6px;font-size:12px"><span style="width:10px;height:10px;border-radius:50%;background:${col};display:inline-block"></span>${c} <span style="opacity:.6">(${n})</span></div>`;
      }).join('');
    }

    function updateCategoryOptions(data){
      const sel = $('#cat');
      const current = sel.value;
      const cats = Array.from(new Set(data.map(getCategory))).sort();
      sel.innerHTML = '<option value="">Toutes cat√©gories</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
      if (current) sel.value = current;
    }

    function applyFilters(data){
      const q = normStr($('#q').value);
      const cat = $('#cat').value;
      return data.filter(item => {
        const hay = [getName(item), getCity(item), getCategory(item), ...getTags(item)].map(normStr).join(' ');
        const okQ = q ? hay.includes(q) : true;
        const okCat = cat ? getCategory(item) === cat : true;
        return okQ && okCat;
      });
    }

    function updateURLFromControls(){
      const q = $('#q').value; const cat = $('#cat').value;
      const p = new URLSearchParams(location.search);
      if (q) p.set('q', q); else p.delete('q');
      if (cat) p.set('cat', cat); else p.delete('cat');
      if (JSON_URL) p.set('data', JSON_URL);
      history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
    }

    function applyControlsFromURL(){
      const q = params.get('q') || '';
      const cat = params.get('cat') || '';
      $('#q').value = q; $('#cat').value = cat;
    }

    // ====== üì• DATA LOADING ======
    async function loadData(){
      try{
        const res = await fetch(JSON_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        allData = Array.isArray(json) ? json : (json.items || json.data || []);
        if (!Array.isArray(allData)) throw new Error('Format JSON non support√©');
        addPoints(allData);
      }catch(err){
        console.error(err);
        showToast(`Erreur de chargement des donn√©es (${err.message}). V√©rifie l'URL JSON.`, { error:true, duration:5000 });
      }
    }

    // ====== üí° EVENTS ======
    document.addEventListener('DOMContentLoaded', async () => {
      initMap();
      applyControlsFromURL();
      await loadData();

      $('#q').addEventListener('input', () => addPoints(allData));
      $('#cat').addEventListener('change', () => addPoints(allData));
      $('#resetBtn').addEventListener('click', (e)=>{
        e.preventDefault();
        $('#q').value=''; $('#cat').value='';
        addPoints(allData);
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hobivia ‚Äî Carte</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Leaflet core -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- MarkerCluster (optionnel mais recommand√© pour beaucoup de points) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer></script>

  <style>
    :root{ --vert:#1B4F46; --beige:#EDE6DA; --cta:#D07B4E; --noir:#1c1f1e; --blanc:#fff; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--beige);}    
    .page{display:grid;grid-template-rows:auto 1fr;min-height:100vh}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--noir);color:var(--blanc);position:sticky;top:0;z-index:1000}
    header .brand{font-weight:600;letter-spacing:.3px}
    header .controls{display:flex;gap:8px;flex-wrap:wrap}
    .control{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);border-radius:12px;padding:8px 10px}
    .control input,.control select{background:transparent;border:none;outline:none;color:#fff}
    .control input::placeholder{color:#ddd}
    #map{width:100%;height:calc(100vh - 140px)}
    .pill{background:#fff;color:#222;border-radius:999px;padding:2px 10px;font-size:12px;border:1px solid #e3e3e3}
    .legend{position:absolute;right:12px;bottom:12px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:8px 10px;z-index:600}
    .legend h4{margin:0 0 6px 0;font-size:13px}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);font-size:14px;z-index:2000;display:none}
    .error{background:#b00020}
    .hidden{display:none}
    a.btn{color:#fff;text-decoration:none}
  .hero{position:relative;overflow:hidden;background:linear-gradient(135deg, rgba(27,79,70,.08), rgba(208,123,78,.08));border-bottom:1px solid rgba(0,0,0,.06)}
    .hero-inner{max-width:1100px;margin:0 auto;padding:18px 16px;display:flex;align-items:center;gap:16px}
    .hero h1{margin:0;font-size:18px;line-height:1.35;color:#1c1f1e;font-weight:600}
    .flow{position:absolute;inset:0;pointer-events:none}
    .blob{position:absolute;top:50%;width:38vw;max-width:520px;aspect-ratio:1/1;border-radius:50%;filter:blur(30px);opacity:.18}
    .blob.left{left:-20vw;background:radial-gradient(circle at 30% 50%, var(--vert), transparent 60%);animation:slideLeft 9s ease-in-out infinite alternate}
    .blob.right{right:-20vw;background:radial-gradient(circle at 70% 50%, var(--cta), transparent 60%);animation:slideRight 9s ease-in-out infinite alternate}
    @keyframes slideLeft{from{transform:translateX(-4vw)} to{transform:translateX(10vw)}}
    @keyframes slideRight{from{transform:translateX(4vw)} to{transform:translateX(-10vw)}}
    .fade-in{animation:fadeIn .6s ease-out both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none}}
    .slide-in-left{animation:slideInLeft .7s cubic-bezier(.22,1,.36,1) both}
    .slide-in-right{animation:slideInRight .7s cubic-bezier(.22,1,.36,1) both}
    @keyframes slideInLeft{from{opacity:0;transform:translateX(-16px)} to{opacity:1;transform:none}}
    @keyframes slideInRight{from{opacity:0;transform:translateX(16px)} to{opacity:1;transform:none}}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">üó∫Ô∏è Hobivia ¬∑ Carte</div>
      <div class="controls slide-in-right">
        <label class="control" title="Recherche texte">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35" stroke="#fff" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#fff" stroke-width="2"/></svg>
          <input id="q" type="search" placeholder="Rechercher‚Ä¶ (nom, ville, tags)" />
        </label>
        <label class="control" title="Filtrer par cat√©gorie">
          <select id="cat">
            <option value="">Toutes cat√©gories</option>
          </select>
        </label>
        <a id="resetBtn" class="control btn" href="#" title="R√©initialiser">R√©initialiser</a>
      </div>
    </header>

    <section class="hero fade-in" aria-label="Intro carte Hobivia">
      <div class="flow">
        <div class="blob left"></div>
        <div class="blob right"></div>
      </div>
      <div class="hero-inner">
        <h1 class="slide-in-left">Chaque point sur la carte est une exp√©rience unique √† vivre. Lequel sera le tien ?</h1>
      </div>
    </section>

    <div id="map" class="fade-in"></div>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
    // ====== üîó CONFIG ======
    // ‚ö†Ô∏è Remplace l'URL ci-dessous par le lien de TON JSON global (m√™me domaine recommand√© pour √©viter CORS).
    const JSON_URL = (new URLSearchParams(location.search).get('data'))
      || '/assets/hobivia.global.json'; // chemin par d√©faut vers le JSON global

    // ====== üß† UTIL ======
    const $ = sel => document.querySelector(sel);
    const params = new URLSearchParams(location.search);
    function showToast(msg, opts={}){
      const el = $('#toast');
      el.textContent = msg; el.className = 'toast ' + (opts.error ? 'error' : '');
      el.style.display = 'block';
      setTimeout(()=>{ el.style.display='none'; }, opts.duration||3000);
    }
    function normStr(v){ return (v||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); }

    // Robust extractor to handle multiple possible key names
    function getLatLng(item){
      const lat = item.lat ?? item.latitude ?? item.Latitude ?? item.LAT;
      const lng = item.lng ?? item.lon ?? item.longitude ?? item.Longitude ?? item.LNG ?? item.LON;
      return [Number(lat), Number(lng)];
    }

    function getName(item){ return item.name ?? item.title ?? item.nom ?? item.Nom ?? 'Sans nom'; }
    function getCategory(item){ return item.category ?? item.categorie ?? item.type ?? 'Divers'; }
    function getCity(item){ return item.city ?? item.ville ?? item.location ?? ''; }
    function getTags(item){
      const tags = item.tags ?? item.motsCles ?? item.keywords ?? [];
      return Array.isArray(tags) ? tags : (typeof tags === 'string' ? tags.split(',').map(t=>t.trim()) : []);
    }
    function getPopupHtml(item){
      const name = getName(item);
      const city = getCity(item);
      const cat = getCategory(item);
      const url = item.url ?? item.link ?? item.slug ?? null;
      const desc = item.shortDescription ?? item.resume ?? item.description ?? '';
      const img = item.image ?? item.thumbnail ?? null;
      const lines = [];
      lines.push(`<div style="min-width:220px;max-width:280px">`);
      if (img) lines.push(`<img src="${img}" alt="${name}" style="width:100%;border-radius:10px;margin-bottom:8px;object-fit:cover;max-height:140px"/>`);
      lines.push(`<div style="font-weight:600;margin-bottom:4px">${name}</div>`);
      lines.push(`<div style="font-size:12px;color:#444;margin-bottom:6px">${[city, cat].filter(Boolean).join(' ‚Ä¢ ')}</div>`);
      if (desc) lines.push(`<div style="font-size:13px;line-height:1.3;margin-bottom:8px">${desc}</div>`);
      if (url) lines.push(`<a href="${url}" target="_blank" rel="noopener" style="display:inline-block;padding:6px 10px;border-radius:8px;background:#1B4F46;color:#fff;text-decoration:none">Voir la fiche</a>`);
      lines.push(`</div>`);
      return lines.join('');
    }

    // ====== üó∫Ô∏è MAP ======
    let map, clusterGroup, allData = [], markers = [];

    function initMap(){
      map = L.map('map', { zoomControl: true, minZoom: 2 });
      const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      clusterGroup = L.markerClusterGroup({
        showCoverageOnHover: false,
        spiderfyOnMaxZoom: true,
        disableClusteringAtZoom: 12
      });
      map.addLayer(clusterGroup);
      map.setView([20, 0], 2);
    }

    function addPoints(data){
      clusterGroup.clearLayers();
      markers = [];

      const filtered = applyFilters(data);
      filtered.forEach(item => {
        const [lat, lng] = getLatLng(item);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
        const marker = L.marker([lat, lng]);
        marker.bindPopup(getPopupHtml(item));
        clusterGroup.addLayer(marker);
        markers.push(marker);
      });
      fitToMarkers();
      updateCategoryOptions(data);
      updateURLFromControls();
      updateLegend(filtered.length);
    }

    function fitToMarkers(){
      if (markers.length === 0) { map.setView([20,0], 2); return; }
      const group = L.featureGroup(markers);
      try {
        map.fitBounds(group.getBounds().pad(0.15), { animate: false });
      } catch(e){ /* ignore */ }
    }

    function updateLegend(count){
      let el = document.querySelector('.legend');
      if (!el){
        el = document.createElement('div');
        el.className = 'legend';
        el.innerHTML = '<h4>R√©sultats</h4><div id="legendCount">‚Äî</div>';
        document.body.appendChild(el);
      }
      document.getElementById('legendCount').textContent = `${count} point${count>1?'s':''}`;
    }

    function updateCategoryOptions(data){
      const sel = $('#cat');
      const current = sel.value;
      const cats = Array.from(new Set(data.map(getCategory))).sort();
      sel.innerHTML = '<option value="">Toutes cat√©gories</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
      if (current) sel.value = current; // preserve current selection if still present
    }

    function applyFilters(data){
      const q = normStr($('#q').value);
      const cat = $('#cat').value;
      return data.filter(item => {
        const hay = [getName(item), getCity(item), getCategory(item), ...getTags(item)].map(normStr).join(' ');
        const okQ = q ? hay.includes(q) : true;
        const okCat = cat ? getCategory(item) === cat : true;
        return okQ && okCat;
      });
    }

    function updateURLFromControls(){
      const q = $('#q').value; const cat = $('#cat').value;
      const p = new URLSearchParams(location.search);
      if (q) p.set('q', q); else p.delete('q');
      if (cat) p.set('cat', cat); else p.delete('cat');
      if (JSON_URL) p.set('data', JSON_URL);
      history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
    }

    function applyControlsFromURL(){
      const q = params.get('q') || '';
      const cat = params.get('cat') || '';
      $('#q').value = q; $('#cat').value = cat;
    }

    // ====== üì• DATA LOADING ======
    async function loadData(){
      try{
        const res = await fetch(JSON_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        // Accept either an array or an object like {items:[...]}
        allData = Array.isArray(json) ? json : (json.items || json.data || []);
        if (!Array.isArray(allData)) throw new Error('Format JSON non support√©');
        addPoints(allData);
      }catch(err){
        console.error(err);
        showToast(`Erreur de chargement des donn√©es (${err.message}). V√©rifie l'URL JSON.`, { error:true, duration:5000 });
      }
    }

    // ====== üí° EVENTS ======
    document.addEventListener('DOMContentLoaded', async () => {
      initMap();
      applyControlsFromURL();
      await loadData();

      $('#q').addEventListener('input', () => addPoints(allData));
      $('#cat').addEventListener('change', () => addPoints(allData));
      $('#resetBtn').addEventListener('click', (e)=>{
        e.preventDefault();
        $('#q').value=''; $('#cat').value='';
        addPoints(allData);
      });
    });
  </script>
</body>
</html>

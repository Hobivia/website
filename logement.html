<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Logement — Hobivia</title>
  <meta name="description" content="Fiche logement Hobivia : images, description, prix et réservation.">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>
  <div data-include="partials/header.html"></div>
  <main id="content" tabindex="-1">
    <div data-include="partials/cursor.html"></div>
    <section class="section">
      <article id="lodging-detail" class="detail glass" aria-live="polite">
        <header>
          <h1 id="lodging-title" class="h1">Chargement…</h1>
          <p id="lodging-location" class="muted"></p>
        </header>

        <div class="slider" id="slider" aria-label="Galerie d’images" tabindex="0"></div>

        <div class="detail-grid">
          <div>
            <p id="lodging-description" class="body"></p>
            <div class="actions">
              <span id="lodging-price" class="badge price"></span>
              <a id="lodging-book" class="btn btn-cta" target="_blank" rel="noopener" aria-label="Réserver ce logement">Réserver</a>
            </div>
          </div>
          <div>
            <div id="detail-map" class="hbv-map" aria-label="Carte du logement"></div>
          </div>
        </div>
      </article>
    </section>
  </main>
  <div data-include="partials/footer.html"></div>

  <script src="assets/js/partials-loader.js"></script>
  <script>
    includePartials().then(() => {
      const leafletJS = document.createElement('script');
      leafletJS.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
      leafletJS.onload = init;
      document.body.appendChild(leafletJS);

      async function init(){
        const params = new URLSearchParams(location.search);
        const id = params.get('id') || params.get('slug');
        const res = await fetch('/.netlify/functions/lodgings' + (id ? ('?id=' + encodeURIComponent(id)) : ''));
        const data = await res.json();
        const item = data.items?.[0];
        if(!item){
          document.getElementById('lodging-title').textContent = 'Logement introuvable';
          return;
        }

        document.title = `${item.title} — Hobivia`;
        document.getElementById('lodging-title').textContent = item.title;
        document.getElementById('lodging-location').textContent =
          [item.location?.city, item.location?.region, item.location?.country].filter(Boolean).join(', ');
        document.getElementById('lodging-description').textContent = item.description || item.shortDescription || '';
        document.getElementById('lodging-price').textContent = `À partir de ${new Intl.NumberFormat('fr-FR').format(item.priceFrom)} €`;
        const book = document.getElementById('lodging-book');
        book.href = item.bookingUrl || '#';

        const slider = document.getElementById('slider');
        (item.images || []).forEach(src => {
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.decoding = 'async';
          img.alt = `Photo de ${item.title}`;
          img.src = src;
          slider.appendChild(img);
        });

        const map = L.map('detail-map', { scrollWheelZoom:false }).setView([item.location.lat, item.location.lng], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
        L.marker([item.location.lat, item.location.lng]).addTo(map).bindPopup(item.title);
      }
    });
  </script>
</body>
</html>

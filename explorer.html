<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Hobivia — Explorer</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root{
  --vert:#1B4F46; --beige:#EDE6DA; --cta:#D07B4E; --noir:#1c1f1e; --blanc:#fff;
  --glass:rgba(255,255,255,.14); --brd:rgba(255,255,255,.35); --shadow:0 10px 30px rgba(0,0,0,.18);
  --badge:rgba(255,255,255,.45);
  --act-peche:#2f7e72; --act-rando:#5b7d2b; --act-vtt:#7b3c9e; --act-surf:#1f6fb2; /* couleurs activité */
}
*{box-sizing:border-box} html,body{margin:0}
body{font-family:Inter,sans-serif;background:var(--beige);color:var(--noir)}
.container{max-width:1180px;margin:0 auto;padding:0 20px}
h1,h2,h3{font-family:"Space Grotesk",sans-serif;color:var(--vert);margin:0}

/* Glass + boutons */
.glass{background:var(--glass);border:1px solid var(--brd);backdrop-filter:blur(14px);border-radius:22px;box-shadow:var(--shadow)}
.btn{display:inline-flex;align-items:center;gap:.55rem;background:var(--cta);color:#fff;padding:.65rem 1.1rem;border-radius:999px;font-weight:700;text-decoration:none;transition:.3s;box-shadow:0 4px 14px rgba(0,0,0,.15)}
.btn:hover{transform:translateY(-2px) scale(1.02);background:#b8673f}

/* Header: logo centré */
.header{position:sticky;top:0;z-index:40;margin-top:8px}
.header .bar{display:flex;justify-content:center;align-items:center;padding:12px 14px}
.brand img{height:48px}

/* Accroche qui s’estompe au scroll */
.lead-wrap{position:relative}
.lead{margin:16px 0 12px;padding:14px 18px;text-align:center}
.fade-on-scroll{transition:opacity .4s ease, transform .4s ease}

/* Filtres */
.tools{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
.select,.input{border:1px solid var(--brd);background:rgba(255,255,255,.35);padding:.65rem .9rem;border-radius:14px}
.input{min-width:220px}
.badge{display:inline-block;background:var(--badge);padding:.3rem .55rem;border-radius:999px;font-size:.82rem}

/* Carte */
#map{height:560px;border-radius:20px;overflow:hidden}
.hobi-pin{width:20px;height:20px;border-radius:50%;border:2.5px solid #ffffffcc;box-shadow:0 6px 14px rgba(0,0,0,.25)}

/* Liste */
.section{padding:22px 0 46px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{display:grid;grid-template-columns:160px 1fr;gap:12px;padding:12px;background:rgba(255,255,255,.18);border:1px solid var(--brd);border-radius:16px;overflow:hidden;position:relative}
.card .media{position:relative}
.card img{width:160px;height:120px;object-fit:cover;border-radius:12px;display:block}
.carousel-btn{position:absolute;top:8px;right:8px;display:flex;gap:6px}
.carousel-btn button{border:0;border-radius:999px;padding:.3rem .45rem;background:rgba(0,0,0,.45);color:#fff;font-weight:700;cursor:pointer}
.card h3{margin:0 0 6px}
.meta{display:flex;gap:8px;flex-wrap:wrap;margin:.25rem 0}
.meta .pill{background:var(--badge);padding:.25rem .55rem;border-radius:999px;font-size:.82rem}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:.5rem}

/* Animations scroll: out-in droite/gauche */
.card{opacity:1;transform:translateX(0);transition:opacity .5s ease, transform .6s ease}
.card.out-right{opacity:0;transform:translateX(60px)}
.card.out-left{opacity:0;transform:translateX(-60px)}
.card.in-right{opacity:1;transform:translateX(0)}
.card.in-left{opacity:1;transform:translateX(0)}

/* Footer sombre */
footer{margin-top:28px;padding:28px 0 60px}
.footer-top{display:grid;gap:18px;grid-template-columns:1.2fr .8fr}
@media(max-width:980px){.footer-top{grid-template-columns:1fr}}
.footer-top h3, .footer-note, footer a, label{color:#0b2f2a}
.footer-links{display:grid;gap:8px;grid-template-columns:repeat(3,1fr)}
.footer-links a{padding:.35rem .4rem;border-radius:8px}
.footer-links a:hover{background:rgba(0,0,0,.06)}
.field{display:grid;margin-bottom:10px}
input, textarea{border:1px solid var(--brd);background:rgba(255,255,255,.35);padding:.7rem .9rem;border-radius:12px;color:#0b2f2a}
textarea{min-height:120px;resize:vertical}

/* Reveal + curseur glass */
.reveal{opacity:0;transform:translateY(16px);transition:opacity .6s ease, transform .6s ease}
.reveal.in{opacity:1;transform:none}
body{cursor:none}
.cursor{position:fixed;inset:0;pointer-events:none;z-index:9999}
.cursor-dot{position:absolute;width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,.25);border:1px solid var(--brd);backdrop-filter:blur(8px);transform:translate(-50%,-50%);box-shadow:0 6px 18px rgba(0,0,0,.12)}
@media(hover:none){body{cursor:auto}.cursor{display:none}}
</style>
</head>
<body>

<!-- Curseur -->
<div class="cursor"><div class="cursor-dot" id="cursor"></div></div>

<!-- Header -->
<header class="header container">
  <div class="bar glass">
    <a class="brand" href="index.html"><img src="images/logo-hobivia.png" alt="Hobivia"></a>
  </div>
</header>

<main class="container">
  <!-- Accroche -->
  <div class="lead-wrap">
    <div id="lead" class="lead glass fade-on-scroll">
      Trouver le <strong>bon logement</strong>, c’est garantir une expérience qui respecte ton activité <em>et</em> ton confort.
    </div>
  </div>

  <!-- Filtres -->
  <div class="tools">
    <select id="f-pays" class="select glass">
      <option value="">Tous pays</option>
      <option>France</option>
      <option>Italie</option>
      <option>Suisse</option>
      <option>Norvège</option>
      <option>Espagne</option>
      <option>Finlande</option>
    </select>
    <select id="f-activite" class="select glass">
      <option value="">Toutes activités</option>
      <option>Pêche</option>
      <option>Randonnée</option>
      <option>VTT</option>
      <option>Surf</option>
    </select>
    <select id="f-prix" class="select glass">
      <option value="">Tous prix</option>
      <option value="€">€</option>
      <option value="€€">€€</option>
      <option value="€€€">€€€</option>
    </select>
    <input id="q" class="input glass" placeholder="Rechercher (ex: lac, cabane…)"/>
  </div>

  <!-- Carte -->
  <div id="map" class="glass reveal"></div>

  <!-- Légende -->
  <p style="margin:10px 0 0">
    <span class="badge" style="background:linear-gradient(180deg,var(--act-peche),#1b4f46);color:#fff">Pêche</span>
    <span class="badge" style="background:linear-gradient(180deg,var(--act-rando),#3f5b19);color:#fff">Randonnée</span>
    <span class="badge" style="background:linear-gradient(180deg,var(--act-vtt),#512a6e);color:#fff">VTT</span>
    <span class="badge" style="background:linear-gradient(180deg,var(--act-surf),#124d84);color:#fff">Surf</span>
  </p>

  <!-- Liste -->
  <section class="section">
    <h2 class="reveal">Tous les logements</h2>
    <div id="list" class="grid"></div>
  </section>
</main>

<!-- Footer -->
<footer class="container">
  <div class="footer-top glass">
    <div>
      <h3>Hobivia</h3>
      <p class="footer-note">Le meilleur des hébergements de passions. Trouve un lieu pensé pour ce que tu aimes faire.</p>
      <div class="footer-links">
        <div>
          <strong>Pages</strong><br>
          <a href="index.html">Accueil</a><br>
          <a href="explorer.html">Explorer</a><br>
          <a href="peche.html">Pêche</a><br>
          <a href="destinations.html">Destinations</a><br>
          <a href="logement.html?id=1">Logement</a>
        </div>
        <div>
          <strong>Réseaux</strong><br>
          <a href="#">Instagram</a><br>
          <a href="#">TikTok</a><br>
          <a href="#">YouTube</a>
        </div>
        <div>
          <strong>Légal</strong><br>
          <a href="#">Mentions</a><br>
          <a href="#">CGU</a><br>
          <a href="#">Presse</a>
        </div>
      </div>
    </div>
    <div>
      <h3>Contact</h3>
      <form id="contact-form">
        <div class="field"><label>Nom</label><input required placeholder="Votre nom"/></div>
        <div class="field"><label>Email</label><input type="email" required placeholder="vous@exemple.com"/></div>
        <div class="field"><label>Message</label><textarea required placeholder="Votre message…"></textarea></div>
        <button class="btn" type="submit">Envoyer</button>
      </form>
      <p id="ok" style="display:none;margin-top:10px;color:#0b2f2a">Merci ! Message envoyé (démo).</p>
    </div>
  </div>
</footer>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ====== Config ====== */
// Remplace par un JSON global si tu en as un
const JSON_URL = "data/hobivia-peche.json";
const FALLBACK = "https://images.unsplash.com/photo-1502920917128-1aa500764cbd?q=80&w=1200&auto=format&fit=crop";

const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);

const lead = $('#lead');
let lastY = window.scrollY;

/* Curseur glass au-dessus de tout */
const dot = document.getElementById('cursor');
window.addEventListener('mousemove',e=>{
  dot.style.top = e.clientY + 'px';
  dot.style.left = e.clientX + 'px';
});

/* Fade de l’accroche au scroll */
window.addEventListener('scroll', ()=>{
  const y = window.scrollY;
  const ratio = Math.min(1, y/180);
  lead.style.opacity = String(1 - ratio);
  lead.style.transform = `translateY(${ratio*12}px)`;
  lastY = y;
});

/* Reveal observer */
const obs = new IntersectionObserver(ents=>{
  ents.forEach(e=>{ if(e.isIntersecting) e.target.classList.add('in'); });
},{threshold:.15});
$$('.reveal').forEach(el=>obs.observe(el));

/* Leaflet */
const map = L.map('map',{scrollWheelZoom:true}).setView([46.6,2.2], 5.5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);

/* Couleurs de pin par activité */
const actColor = (a)=>{
  a = (a||"").toLowerCase();
  if(a.includes("pêche") || a.includes("peche")) return getPin('--act-peche');
  if(a.includes("rando")) return getPin('--act-rando');
  if(a.includes("vtt")) return getPin('--act-vtt');
  if(a.includes("surf")) return getPin('--act-surf');
  return getPin('--act-peche'); // défaut
};
function getPin(varName){
  const col = getComputedStyle(document.documentElement).getPropertyValue(varName).trim() || '#1B4F46';
  const div = L.divIcon({className:'', html:`<div class="hobi-pin" style="background:linear-gradient(180deg,${col},#123)"></div>`, iconSize:[20,20]});
  return div;
}

/* État */
let ALL = [];           // logements normalisés et enrichis
let markers = [];       // markers leaflet
const listEl = document.getElementById('list');

/* Utils */
function shuffle(arr){
  for(let i=arr.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function normalize(x,i){
  // On tolère que le JSON n'ait pas tout
  const photos = Array.isArray(x.photos) && x.photos.length ? x.photos
                : (x.photo_url ? [x.photo_url] : [FALLBACK]);
  return {
    _id: i+1,
    nom: x.nom || "Logement Hobivia",
    commune: x.commune || "",
    pays: x.destination || x.pays || "France",
    activite: x.activite || x.type || "Pêche",
    prix: x.price_from || x.prix || null,   // nombre si dispo
    tier: x.budget || (x.price_from? (x.price_from<120?"€":x.price_from<200?"€€":"€€€") : ""),
    lat: Number(x.latitude), lng: Number(x.longitude),
    photos,
    short: x.short_desc || "",
    lienResa: `logement.html?id=${i+1}` // bouton "Réserver" → fiche logement
  };
}
function moneyFrom(tier){
  if(!tier) return "";
  if(tier==="€") return "À partir de 80 €";
  if(tier==="€€") return "À partir de 150 €";
  if(tier==="€€€") return "À partir de 250 €";
  return "";
}

/* Rendu liste */
function cardHTML(l, idx){
  const img = l.photos[0] || FALLBACK;
  return `
  <article class="card glass" data-idx="${idx}">
    <div class="media">
      <img src="${img}" alt="${l.nom}" onerror="this.src='${FALLBACK}'">
      <div class="carousel-btn">
        <button type="button" data-dir="-1">‹</button>
        <button type="button" data-dir="1">›</button>
      </div>
    </div>
    <div>
      <h3>${l.nom}</h3>
      <div class="meta">
        <span class="pill">${l.commune || l.pays}</span>
        <span class="pill">${l.activite}</span>
        ${l.tier? `<span class="pill">${l.tier}</span>`:""}
      </div>
      ${l.short? `<p style="margin:.4rem 0 .3rem;color:#0f4037">${l.short}</p>`:""}
      <div class="actions">
        ${moneyFrom(l.tier)? `<span class="badge">${moneyFrom(l.tier)}</span>`:""}
        <a class="btn" href="${l.lienResa}" target="_blank" rel="noopener">Réserver</a>
      </div>
    </div>
  </article>`;
}

/* Appliquer filtres */
function matchFilters(l){
  const pays = $('#f-pays').value;
  const act  = $('#f-activite').value;
  const prix = $('#f-prix').value;
  const q    = $('#q').value.trim().toLowerCase();

  const okPays = !pays || (l.pays||"").toLowerCase() === pays.toLowerCase();
  const okAct  = !act  || (l.activite||"").toLowerCase().includes(act.toLowerCase());
  const okPrix = !prix || (l.tier||"") === prix;
  const txt = (l.nom+" "+l.commune+" "+l.pays+" "+l.activite).toLowerCase();
  const okQ = !q || txt.includes(q);
  return okPays && okAct && okPrix && okQ;
}

/* Rendu global */
function render(){
  // Nettoyer
  markers.forEach(m=>map.removeLayer(m)); markers = [];
  listEl.innerHTML = "";

  // Filtrer
  const visible = ALL.filter(matchFilters);

  // Carte
  visible.forEach((l,idx)=>{
    const m = L.marker([l.lat,l.lng],{icon:actColor(l.activite)}).addTo(map)
      .bindPopup(`<strong>${l.nom}</strong><br><small>${l.commune || l.pays}</small><br><a class="btn" style="margin-top:6px" href="${l.lienResa}" target="_blank" rel="noopener">Voir</a>`);
    markers.push(m);
  });
  if(visible.length){
    const b = L.latLngBounds(visible.map(l=>[l.lat,l.lng]));
    map.fitBounds(b.pad(0.2));
  }

  // Liste (aléatoire à chaque rendu)
  const randomized = shuffle([...visible]);
  randomized.forEach((l,idx)=> listEl.insertAdjacentHTML('beforeend', cardHTML(l, idx)));

  // Carrousel par carte
  $$('#list .card').forEach((card,i)=>{
    const idx = ALL.indexOf(randomized[i]); // référence objet
    let pidx = 0;
    const img = card.querySelector('img');
    card.querySelectorAll('.carousel-btn button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const dir = Number(btn.dataset.dir);
        const arr = randomized[i].photos;
        pidx = (pidx + dir + arr.length) % arr.length;
        img.src = arr[pidx] || FALLBACK;
      });
    });
  });
}

/* Animation d’entrée/sortie droite-gauche selon scroll */
let lastScrollY = window.scrollY;
function animateListOnScroll(){
  const currentY = window.scrollY;
  const dirDown = currentY > lastScrollY;
  lastScrollY = currentY;

  const cards = $$('#list .card');
  cards.forEach((c,k)=>{
    const rect = c.getBoundingClientRect();
    const inView = rect.top < window.innerHeight && rect.bottom > 0;
    if(!inView){
      c.classList.remove('in-right','in-left');
      c.classList.add(k%2===0 ? (dirDown?'out-right':'out-left') : (dirDown?'out-left':'out-right'));
    }else{
      c.classList.remove('out-right','out-left');
      c.classList.add(k%2===0 ? (dirDown?'in-right':'in-left') : (dirDown?'in-left':'in-right'));
    }
  });
}
window.addEventListener('scroll', animateListOnScroll);

/* Chargement data */
fetch(JSON_URL)
  .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
  .then(arr=>{
    ALL = (arr||[]).map(normalize).filter(l=>!Number.isNaN(l.lat)&&!Number.isNaN(l.lng));
    render();
    animateListOnScroll();
  })
  .catch(err=>{
    console.error('Erreur JSON:', err);
    alert("Impossible de charger les logements (vérifie l'URL des données).");
  });

/* Filtres */
['f-pays','f-activite','f-prix','q'].forEach(id=> $(id).addEventListener('input', ()=>{ render(); animateListOnScroll(); }));

/* Footer demo form */
document.getElementById('contact-form')?.addEventListener('submit',e=>{
  e.preventDefault(); document.getElementById('ok').style.display='block'; e.target.reset();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hobivia — Explorer</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root{ --vert:#1B4F46; --beige:#EDE6DA; --cta:#D07B4E; --noir:#1c1f1e; --blanc:#fff; --brd:rgba(0,0,0,.08); }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--beige);color:#1c1f1e}
    .page{min-height:100dvh;display:grid;grid-template-rows:auto auto auto 1fr auto}

    /* Hero + effets fluides */
    .hero{position:relative;overflow:hidden;background:linear-gradient(135deg, rgba(27,79,70,.08), rgba(208,123,78,.08));border-bottom:1px solid var(--brd)}
    .hero-inner{max-width:1100px;margin:0 auto;padding:22px 16px}
    .hero h1{margin:0;font-size:20px;line-height:1.35;font-weight:700}
    .flow{position:absolute;inset:0;pointer-events:none}
    .blob{position:absolute;top:50%;width:38vw;max-width:520px;aspect-ratio:1/1;border-radius:50%;filter:blur(30px);opacity:.18}
    .blob.left{left:-20vw;background:radial-gradient(circle at 30% 50%, var(--vert), transparent 60%);animation:slideLeft 9s ease-in-out infinite alternate}
    .blob.right{right:-20vw;background:radial-gradient(circle at 70% 50%, var(--cta), transparent 60%);animation:slideRight 9s ease-in-out infinite alternate}
    @keyframes slideLeft{from{transform:translateX(-4vw)} to{transform:translateX(10vw)}}
    @keyframes slideRight{from{transform:translateX(4vw)} to{transform:translateX(-10vw)}}

    /* Mounts (partiels) */
    .mount{min-height:40px}
    .mount.loading{opacity:.5}
    .mount.error{padding:12px;border-top:1px solid var(--brd);color:#a00;background:#fff}

    /* Liste logements */
    .listing{max-width:1200px;margin:24px auto 80px auto;padding:0 16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden;transition:transform .25s ease, box-shadow .25s ease, opacity .5s ease, transform .5s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 14px 38px rgba(0,0,0,.12)}
    .card img{width:100%;height:160px;object-fit:cover;display:block}
    .card-body{padding:12px}
    .card-title{font-weight:700;margin:0 0 4px 0}
    .card-meta{font-size:12px;color:#666;margin-bottom:8px}
    .card-desc{font-size:13px;line-height:1.35;min-height:2.6em;margin-bottom:10px}
    .price-badge{display:inline-block;font-size:12px;background:#1B4F46;color:#fff;padding:4px 8px;border-radius:999px}
    .actions{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:6px}
    .reserve-btn{appearance:none;border:none;background:#D07B4E;color:#fff;font-weight:700;padding:10px 12px;border-radius:12px;cursor:pointer}
    .reserve-btn:hover{opacity:.92}

    /* Sorties fluides gauche/droite au scroll */
    .fade-item{opacity:1;transform:translateX(0)}
    .fade-out-left{opacity:0;transform:translateX(-24px)}
    .fade-out-right{opacity:0;transform:translateX(24px)}
  </style>
</head>
<body>
  <div class="page">
    <!-- HEADER si tu en as un: on peut aussi le charger en partiel ici -->
    <!-- <div class="mount" data-src="/partials/header.html"></div> -->

    <!-- HERO -->
    <section class="hero" aria-label="Intro">
      <div class="flow"><div class="blob left"></div><div class="blob right"></div></div>
      <div class="hero-inner">
        <h1>Chaque point sur la carte est une expérience unique à vivre. Lequel sera le tien ?</h1>
      </div>
    </section>

    <!-- MAP (depuis /partials/map.html) -->
    <div id="mapMount" class="mount" data-src="/partials/map.html" data-query="data=/data/hobivia-global.json"></div>

    <!-- LISTE LOGEMENTS sous la carte -->
    <section id="logements" aria-label="Liste des logements" class="listing"></section>

    <!-- READER (depuis /partials/reader.html) -->
    <div id="readerMount" class="mount" data-src="/partials/reader.html"></div>

    <!-- FOOTER (depuis /partials/footer.html) -->
    <div id="footerMount" class="mount" data-src="/partials/footer.html"></div>
  </div>

  <script>
    // ========= CONFIG =========
    const DATA_URL = '/data/hobivia-global.json';

    // ========= UTILS =========
    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
    const qs = obj => new URLSearchParams(obj).toString();

    // Charge un partiel HTML et exécute ses <script>
    async function loadPartial(mount){
      const base = mount.getAttribute('data-src');
      if(!base) return;
      const extra = mount.getAttribute('data-query');
      const url = extra ? `${base}?${extra}` : base;

      mount.classList.add('loading');
      try{
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const html = await res.text();

        // Injecte et ré-exécute les scripts
        const tmp = document.createElement('div');
        tmp.innerHTML = html;

        // Remplace le contenu du mount
        mount.innerHTML = '';
        // Cloner et insérer en exécutant les scripts
        tmp.childNodes.forEach(node=>{
          if(node.tagName === 'SCRIPT'){
            const s = document.createElement('script');
            // Copie attributs (src, type, etc.)
            for (const attr of node.attributes || []) s.setAttribute(attr.name, attr.value);
            s.textContent = node.textContent;
            mount.appendChild(s);
          } else {
            mount.appendChild(node.cloneNode(true));
          }
        });
      }catch(e){
        console.error(e);
        mount.classList.add('error');
        mount.innerHTML = `<small>Impossible de charger ${base}. Vérifie le chemin dans /partials et les assets référencés.</small>`;
      }finally{
        mount.classList.remove('loading');
      }
    }

    // ========= LISTE LOGEMENTS (depuis DATA_URL) =========
    const pick = (obj, keys) => { for (const k of keys){ if (obj?.[k]!==undefined && obj?.[k]!==null && obj?.[k]!=="" ) return obj[k]; } };
    const getName = it => pick(it,["name","title","nom","Nom"]) || 'Sans nom';
    const getCity = it => pick(it,["city","ville","location"]) || '';
    const getDesc = it => pick(it,["shortDescription","resume","description"]) || '';
    const getImage = it => it?.image || it?.thumbnail || (Array.isArray(it?.images)&&it.images[0]) || 'https://via.placeholder.com/640x360?text=Hobivia';
    const getCategory = it => pick(it,["category","categorie","type"]) || 'Divers';
    const getPrice = it => {
      const p = pick(it,["priceFrom","price_from","prixFrom","prix","minPrice","prixMin","a_partir_de"]);
      const currency = pick(it,["currency","devise"]) || '€';
      if(p===undefined) return null;
      const n=Number(p); const v=Number.isFinite(n)? Math.round(n): p;
      return `À partir de ${v}${currency==='€'?'€':' '+currency}`;
    };
    const getBookUrl = it => pick(it,["bookingUrl","reserveUrl","url","link","slug"]) || '#';

    function cardTemplate(it, idx){
      const name=getName(it), city=getCity(it), cat=getCategory(it);
      const img=getImage(it), desc=getDesc(it), price=getPrice(it), href=getBookUrl(it);
      const lr = (idx % 2 === 0) ? 'fade-out-left' : 'fade-out-right';
      return `<article class="card ${lr}" data-idx="${idx}">
        <img src="${img}" alt="${name}">
        <div class="card-body">
          <h3 class="card-title">${name}</h3>
          <div class="card-meta">${[city,cat].filter(Boolean).join(' • ')}</div>
          <p class="card-desc">${desc}</p>
          <div class="actions">
            <span class="price-badge">${price || 'Tarif sur demande'}</span>
            <a href="${href}" target="_blank" rel="noopener">
              <button class="reserve-btn" type="button">Réserver</button>
            </a>
          </div>
        </div>
      </article>`;
    }

    function setupScrollFade(root){
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
          const el = entry.target;
          if(entry.isIntersecting){
            el.classList.remove('fade-out-left','fade-out-right');
            el.classList.add('fade-item');
          } else {
            const idx = Number(el.getAttribute('data-idx')) || 0;
            el.classList.remove('fade-item');
            el.classList.add(idx % 2 === 0 ? 'fade-out-left' : 'fade-out-right');
          }
        });
      }, { root:null, threshold:0.15 });
      root.querySelectorAll('.card').forEach(el=>io.observe(el));
    }

    async function renderList(){
      try{
        const res = await fetch(DATA_URL, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        const items = Array.isArray(json) ? json : (json.items || json.data || []);
        const container = document.getElementById('logements');
        container.innerHTML = items.map((it,idx)=>cardTemplate(it, idx)).join('');
        setupScrollFade(container);
      }catch(e){ console.error(e); }
    }

    // ========= BOOT =========
    document.addEventListener('DOMContentLoaded', async () => {
      // Charge les partiels
      await Promise.all($$('.mount').map(loadPartial));
      // Rend la liste
      renderList();
    });
  </script>
</body>
</html>
